<div class="container-fluid mt-4">
  <!-- Barre de recherche -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" class="form-control" placeholder="Rechercher par nom, prénom, email ou téléphone..."[(ngModel)]="search" (ngModelChange)="onSearchChange($event)" />
      </div>
    </div>
  </div>
  <!-- Tableau des clients -->
  <div class="row">
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Nom</th>
              <th>Prénom</th>
              <th>Email</th>
              <th>Téléphone</th>
              <th>Statut</th>
              <th>Date Création</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let client of filteredClients; let i = index">
              <!-- Ligne du client -->
              <tr>
                <td>{{ i + 1 }}</td>
                <td>{{ client.nom }}</td>
                <td>{{ client.prenom }}</td>
                <td>{{ client.email }}</td>
                <td>{{ client.telephone }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatutClass(client.statut)">
                    {{ client.statut }}
                  </span>
                </td>
                <td>{{ client.dateCreation | date:'dd/MM/yyyy' }}</td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <button 
                      class="btn btn-sm btn-info" 
                      (click)="openDetails(client)"
                      title="Voir les détails"
                    >
                      <i class="bi bi-eye"></i> Voir
                    </button>
                    <button 
                      class="btn btn-sm btn-dark" 
                      (click)="toggleHistorique(client, $event)"
                      [class.active]="isHistoriqueOpen(client._id)"
                      title="Afficher l'historique"
                    >
                      <i class="bi bi-clock-history"></i> 
                      {{ isHistoriqueOpen(client._id) ? 'Masquer' : 'Historique' }}
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Ligne d'historique -->
              <tr *ngIf="isHistoriqueOpen(client._id)" class="historique-row">
                <td colspan="8" class="p-0">
                  <div class="historique-container p-3">
                    <div *ngIf="client.historiqueModifications && client.historiqueModifications.length > 0">
                      <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white">
                          <h6 class="mb-0">
                            <i class="bi bi-clock-history"></i> 
                            Historique des modifications - {{ client.nom }} {{ client.prenom }}
                          </h6>
                        </div>
                        <div class="card-body p-0">
                          <div class="table-responsive">
                            <table class="table table-sm mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th>Date</th>
                                  <th>Champ modifié</th>
                                  <th>Ancienne valeur</th>
                                  <th></th>
                                  <th>Nouvelle valeur</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr *ngFor="let h of client.historiqueModifications">
                                  <td class="text-muted">
                                    <small>
                                      <i class="bi bi-calendar"></i>
                                      {{ h.date | date:'dd/MM/yyyy HH:mm' }}
                                    </small>
                                  </td>
                                  <td>
                                    <strong class="text-primary">{{ h.champ }}</strong>
                                  </td>
                                  <td>
                                    <span class="badge bg-danger">{{ h.ancienneValeur }}</span>
                                  </td>
                                  <td class="text-center">
                                    <i class="bi bi-arrow-right text-muted"></i>
                                  </td>
                                  <td>
                                    <span class="badge bg-success">{{ h.nouvelleValeur }}</span>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div *ngIf="!client.historiqueModifications || client.historiqueModifications.length === 0" 
                         class="alert alert-info mb-0">
                      <i class="bi bi-info-circle"></i> 
                      Aucune modification n'a été effectuée sur ce client.
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>

            <!-- Message si aucun client -->
            <tr *ngIf="filteredClients.length === 0">
              <td colspan="8" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox" style="font-size: 4rem; opacity: 0.3;"></i>
                  <p class="mt-3 mb-0">
                    <strong>Aucun client trouvé</strong>
                  </p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- Modal détails / édition client -->
<div 
  class="modal fade show" tabindex="-1" [ngStyle]="{display: selectedClient ? 'block' : 'none'}" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header" [ngClass]="isEditMode ? 'bg-warning' : 'bg-primary'" class="text-white">
        <h5 class="modal-title text-white p-2 m-2">
          {{ isEditMode ? 'Modifier le client' : 'Détails du client' }}
        </h5>
      </div>
      <!-- Body - MODE LECTURE -->
      <div class="modal-body" *ngIf="selectedClient && !isEditMode">
        <!-- Messages -->
        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
          <i class="bi bi-check-circle"></i> {{ successMessage }}
        </div>
        <div class="row g-3">
          <!-- Informations personnelles -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="bi bi-person"></i> Informations personnelles
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2">
                  <strong>Nom complet :</strong><br>
                  {{ selectedClient.nom }} {{ selectedClient.prenom }}
                </p>
                <p class="mb-2">
                  <strong>Email :</strong><br>
                  <a href="mailto:{{ selectedClient.email }}">{{ selectedClient.email }}</a>
                </p>
                <p class="mb-2">
                  <strong>Téléphone :</strong><br>
                  <a href="tel:{{ selectedClient.telephone }}">{{ selectedClient.telephone }}</a>
                </p>
                <p class="mb-0">
                  <strong>Statut :</strong><br>
                  <span class="badge" [ngClass]="getStatutClass(selectedClient.statut)">
                    {{ selectedClient.statut | uppercase }}
                  </span>
                </p>
              </div>
            </div>
          </div>
          <!-- Adresse -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="bi bi-geo-alt"></i> Adresse
                </h6>
              </div>
              <div class="card-body">
                <address class="mb-0">
                  <strong>{{ selectedClient.adresse.rue || 'N/A' }}</strong><br>
                  {{ selectedClient.adresse.codePostal || 'N/A' }} 
                  {{ selectedClient.adresse.ville || 'N/A' }}<br>
                  {{ selectedClient.adresse.pays || 'N/A' }}
                </address>
              </div>
            </div>
          </div>
          <!-- Informations financières -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="bi bi-wallet2"></i> Informations financières
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-0">
                  <strong>Solde Compte :</strong><br>
                  <span class="fs-4 text-primary">
                    {{ selectedClient.soldeCompte | number:'1.2-2' }} DT
                  </span>
                </p>
              </div>
            </div>
          </div>
          <!-- Dates -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="bi bi-calendar"></i> Informations temporelles
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2">
                  <strong>Date de création :</strong><br>
                  {{ selectedClient.dateCreation | date:'dd/MM/yyyy à HH:mm' }}
                </p>
                <p class="mb-0">
                  <strong>Modifications :</strong><br>
                  {{ selectedClient.historiqueModifications.length || 0 }} modification(s)
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Body - MODE ÉDITION -->
      <div class="modal-body" *ngIf="isEditMode">
        <!-- Messages -->
        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
          <i class="bi bi-exclamation-triangle"></i> {{ errorMessage }}
        </div>
        <form [formGroup]="clientForm">
          <!-- Informations personnelles -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bi bi-person"></i> Informations personnelles</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nom <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="nom"
                    [class.is-invalid]="nom?.invalid && nom?.touched">
                  <div class="invalid-feedback">Le nom est requis (min 2 caractères)</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Prénom <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="prenom"
                    [class.is-invalid]="prenom?.invalid && prenom?.touched">
                  <div class="invalid-feedback">Le prénom est requis (min 2 caractères)</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" formControlName="email"
                    [class.is-invalid]="email?.invalid && email?.touched">
                  <div class="invalid-feedback">Email invalide</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Téléphone <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="telephone"
                    [class.is-invalid]="telephone?.invalid && telephone?.touched">
                  <div class="invalid-feedback">Format invalide (8 chiffres min)</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Statut <span class="text-danger">*</span></label>
                  <select class="form-select" formControlName="statut">
                    <option value="actif">Actif</option>
                    <option value="inactif">Inactif</option>
                    <option value="suspendu">Suspendu</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Solde Compte (DT) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" formControlName="soldeCompte"
                    [class.is-invalid]="soldeCompte?.invalid && soldeCompte?.touched">
                  <div class="invalid-feedback">Le solde ne peut pas être négatif</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Adresse -->
          <div class="card mb-3" formGroupName="adresse">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bi bi-geo-alt"></i> Adresse</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Rue <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="rue"
                    [class.is-invalid]="adresse.get('rue')?.invalid && adresse.get('rue')?.touched">
                  <div class="invalid-feedback">La rue est requise</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ville <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="ville"
                    [class.is-invalid]="adresse.get('ville')?.invalid && adresse.get('ville')?.touched">
                  <div class="invalid-feedback">La ville est requise</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Code Postal <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="codePostal"
                    [class.is-invalid]="adresse.get('codePostal')?.invalid && adresse.get('codePostal')?.touched">
                  <div class="invalid-feedback">Le code postal est requis</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Pays <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" formControlName="pays"
                    [class.is-invalid]="adresse.get('pays')?.invalid && adresse.get('pays')?.touched">
                  <div class="invalid-feedback">Le pays est requis</div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- Footer -->
      <div class="modal-footer">
        <!-- Mode LECTURE -->
        <ng-container *ngIf="!isEditMode">
          <button type="button" class="btn btn-secondary" (click)="closeModal()"><i class="bi bi-x-circle"></i> Fermer</button>
          <button type="button" class="btn btn-warning" (click)="switchToEditMode()"><i class="bi bi-pencil"></i> Modifier</button>
        </ng-container>
        <!-- Mode ÉDITION -->
        <ng-container *ngIf="isEditMode">
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()" [disabled]="isSaving">
            <i class="bi bi-x-circle"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" (click)="saveClient()" [disabled]="clientForm.invalid || isSaving">
            <span *ngIf="!isSaving">
              <i class="bi bi-check-circle"></i> Enregistrer
            </span>
            <span *ngIf="isSaving">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Enregistrement...
            </span>
          </button>
        </ng-container>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="selectedClient" (click)="closeModal()"></div>