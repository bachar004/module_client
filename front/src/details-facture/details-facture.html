<div class="container-fluid p-4">
  <!-- En-tête -->
  <div class="header-section mb-4">
    <h2 class="page-title">
      <i class="bi bi-receipt"></i> Détails de la Facture
    </h2>
    <div>
      <button class="btn btn-outline-secondary me-2" (click)="retour()">
        <i class="bi bi-arrow-left"></i> Retour
      </button>
      <button class="btn btn-outline-primary" (click)="imprimerFacture()">
        <i class="bi bi-printer"></i> Imprimer
      </button>
    </div>
  </div>

  <!-- Erreur -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = ''"></button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-2">Chargement de la facture...</p>
  </div>

  <!-- Contenu de la facture -->
  <div *ngIf="!loading && facture" class="row">
    <div class="col-lg-8">
      <!-- Informations principales -->
      <div class="card mb-4 facture-card">
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <h3 class="mb-3">{{ facture.numeroFacture }}</h3>
              <p class="mb-1">
                <strong>Date:</strong> {{ facture.dateFacture | date:'dd/MM/yyyy à HH:mm' }}
              </p>
              <p class="mb-1">
                <strong>Statut:</strong>
                <span class="badge ms-2" [ngClass]="getStatutBadgeClass(facture.statut)">
                  {{ getStatutLabel(facture.statut) }}
                </span>
              </p>
              <p class="mb-1" *ngIf="facture.modePaiement">
                <strong>Mode de paiement:</strong> {{ getModePaiementLabel(facture.modePaiement) }}
              </p>
            </div>
            <div class="col-md-6 text-md-end">
              <h5 class="text-muted mb-2">Informations Client</h5>
              <p class="mb-1">
                <strong>{{ facture.client?.prenom }} {{ facture.client?.nom }}</strong>
              </p>
              <p class="mb-1">{{ facture.client?.email }}</p>
              <p class="mb-1" *ngIf="facture.client?.telephone">
                <i class="bi bi-telephone"></i> {{ facture.client?.telephone }}
              </p>
              <p class="mb-1" *ngIf="facture.client?.adresse">
                <i class="bi bi-geo-alt"></i> {{ facture.client?.adresse }}
              </p>
            </div>
          </div>

          <hr>

          <!-- Articles de la commande -->
          <h5 class="mb-3">
            <i class="bi bi-box"></i> Articles
          </h5>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Produit</th>
                  <th class="text-center">Quantité</th>
                  <th class="text-end">Prix unitaire</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let article of facture.commande?.articles">
                  <td>{{ article.produit }}</td>
                  <td class="text-center">{{ article.quantite }}</td>
                  <td class="text-end">{{ article.prixUnitaire | number:'1.2-2' }} DT</td>
                  <td class="text-end"><strong>{{ article.total | number:'1.2-2' }} DT</strong></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Notes de la commande -->
          <div *ngIf="facture.commande?.notes" class="alert alert-info mt-3">
            <strong><i class="bi bi-info-circle"></i> Notes:</strong>
            <p class="mb-0 mt-2">{{ facture.commande.notes }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Résumé financier -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-calculator"></i> Résumé Financier
          </h5>
        </div>
        <div class="card-body">
          <div class="financial-row">
            <span class="label">Montant Total:</span>
            <span class="value">{{ facture.montantTotal | number:'1.2-2' }} DT</span>
          </div>
          <div class="financial-row text-success">
            <span class="label">Montant Payé:</span>
            <span class="value">{{ facture.montantPaye | number:'1.2-2' }} DT</span>
          </div>
          <hr>
          <div class="financial-row total-row">
            <span class="label">Solde Restant:</span>
            <span class="value text-danger">
              <strong>{{ facture.soldeRestant | number:'1.2-2' }} DT</strong>
            </span>
          </div>

          <button 
            *ngIf="facture.statut !== 'payee'"
            class="btn btn-success w-100 mt-4" 
            (click)="effectuerPaiement()"
          >
            <i class="bi bi-credit-card"></i> Effectuer un paiement
          </button>

          <div *ngIf="facture.statut === 'payee'" class="alert alert-success mt-4 mb-0">
            <i class="bi bi-check-circle"></i> Facture entièrement payée
          </div>
        </div>
      </div>

      <!-- Solde du client -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-wallet2"></i> Compte Client
          </h6>
        </div>
        <div class="card-body">
          <div class="financial-row">
            <span class="label">Solde compte:</span>
            <span class="value" [class.text-success]="facture.client?.soldeCompte > 0" 
                  [class.text-danger]="facture.client?.soldeCompte < 0">
              {{ facture.client?.soldeCompte | number:'1.2-2' }} DT
            </span>
          </div>
          <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle"></i> 
            Le solde positif représente un crédit disponible
          </small>
        </div>
      </div>
    </div>
  </div>
</div>